# -*- coding: utf-8 -*-
import re
import json
import requests
import random
from scapy.all import *


def login():
    data = {"username": "username", "password": "password"}
    r = requests.post('https://api.zoomeye.org/user/login', json=data)
    return json.loads(r.text)


def verify(recv):

    if len(recv[0].res) > 0:
        content = (recv[0].res[0][1].original).decode('latin1')
        pattern = re.compile('(STAT|pid|uptime)')
        match = re.search(pattern, content)
        if match is not None:
            return True
        else:
            return False


def main():
    token = login()
    headers = {'Authorization': 'JWT ' + token['access_token']}
    base_url = 'https://api.zoomeye.org/host/search?query=app:memcached%20%2Bcountry:"CN"&page='


    for i in range(1, 200):
        r = requests.get(url=base_url + str(i), headers=headers)
        res = json.loads(r.text)
        try:
            for x in res['matches']:
                ip_addr = x['ip'].strip()
                ip_pkt = IP(dst=ip_addr)
                udp_pkt = UDP(
                    dport=11211, sport=random.randint(1025, 65535))
                payload = '\x00\x00\x00\x00\x00\x01\x00\x00stats\r\n'

                pkt = ip_pkt / udp_pkt / payload
                recv = sr(pkt, timeout=5)

                if verify(recv):
                    with open('mem-res.txt', 'w+') as fw:
                        fw.write(ip_addr + '\n')

        except Exception as e:
            print(e)


if __name__ == '__main__':
    main()
